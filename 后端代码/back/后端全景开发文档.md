# 无人值守巡检系统后端全景开发文档

---

## 1. 项目架构与环境依赖

### 架构概览
- **Spring Boot**：主API网关，管理系统（用户、权限、设备、摄像头、模型、报警、测点、工厂等），统一对前端/第三方暴露接口。
- **Flask + YOLOv5**：负责目标检测、摄像头流、模型训练、视频处理等AI相关服务。
- **MySQL**：业务数据存储。
- **Redis**：Token/session等缓存（如有）。
- **文件存储**：模型、视频、图片、数据集等。

### 主要目录结构
```
/d:/yolo_test/
├── back/                # Spring Boot 后端主目录
│   ├── src/             # Java 源码
│   ├── model/           # 业务相关模型
│   ├── uploads/         # 上传文件存储
│   ├── pom.xml          # Maven 依赖配置
│   └── ...
├── yolov5-master/       # Flask + YOLOv5 检测服务
│   ├── app.py           # Flask 主入口
│   ├── camera_detect_api.py # 摄像头流/检测API
│   ├── detect.py        # YOLOv5 检测脚本
│   ├── models/          # YOLOv5模型代码
│   ├── model/           # 存放.pt模型文件
│   ├── uploads/         # 上传/中转文件
│   ├── requirements.txt # Python依赖
│   └── ...
```

### 环境依赖与部署
- JDK 17+、Maven 3.6+、MySQL 8+、Python 3.8+、pip、CUDA（如需GPU）、Redis（如有）
- Spring Boot 启动：`cd back && mvn clean package && java -jar target/*.jar`
- Flask 启动：`cd yolov5-master && pip install -r requirements.txt && python app.py`
- 数据库建表：`mysql < unmanned-inspection-system.sql`

---

## 2. 数据库设计

### 主要表结构与说明

#### alarm（报警表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| alarm_id       | bigint      | 自增id，主键           |
| device_id      | int         | 所属设备id             |
| mp_id          | bigint      | 所属测点id             |
| type           | tinyint     | 报警类型（同异常测点的状态）|
| description    | varchar(50) | 报警描述               |
| status         | tinyint     | 处置状态               |
| alarm_time     | datetime    | 报警时间               |
| processed_time | datetime    | 处理时间点             |
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### device（设备表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| device_id      | int         | 自增id，主键           |
| device_type    | int         | 设备类型               |
| name           | varchar(32) | 设备名称               |
| run_status     | tinyint     | 运行状态               |
| health_status  | tinyint     | 健康状态               |
| workshop_id    | int         | 车间id                 |
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### measuring_point（测点表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| mp_id          | bigint      | 自增id，主键           |
| device_id      | int         | 测点所属设备id         |
| name           | varchar(32) | 测点名称               |
| type           | tinyint     | 测点类型               |
| status         | tinyint     | 测点状态               |
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### user（用户表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| user_id        | bigint      | 自增id，主键           |
| name/username  | varchar(20/32) | 用户名               |
| password       | varchar(32/64) | 密码（加密存储）      |
| phone_number   | varchar(20) | 手机号                 |
| status         | tinyint(1)  | 状态（0-禁用，1-启用） |
| role/role_type | tinyint(1)  | 角色（0-用户，1-管理员）|
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### workshop（车间表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| workshop_id    | int         | 自增id，主键           |
| name           | varchar(32) | 车间名称               |
| status         | tinyint(1)  | 状态（0-禁用，1-启用） |
| device_count   | int         | 拥有设备数目           |
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### model_pt（模型表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| id             | bigint      | 自增id，主键           |
| file_name      | varchar(128)| 模型文件名             |
| title          | varchar(64/128)| 模型标题             |
| description    | varchar(256/512)| 模型描述             |
| status         | tinyint(1)  | 状态（1-激活，0-未激活）|
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### camera_model_bind（摄像头与模型绑定表）
| 字段名         | 类型         | 说明                   |
| -------------- | ------------| ---------------------- |
| id             | bigint      | 自增id，主键           |
| camera_id      | varchar(64) | 摄像头唯一标识         |
| camera_name    | varchar(128)| 摄像头名称             |
| camera_source  | varchar(128/256)| 摄像头源（编号或流地址）|
| model_name     | varchar(128)| 绑定的模型文件名       |
| create_time    | datetime    | 创建时间               |
| update_time    | datetime    | 更新时间               |

#### 业务记录表（与测点mp_id关联，记录各类状态/数值）
- flowing_water_record（流水状态记录表）
- indicator_record（指示灯状态记录表）
- instrument_record（仪表状态记录表）
- liquid_level_record（液位记录表）
- pipeline_record（管路状态记录表）
- pump_lubrication_record（泵润滑状态记录表）
- pump_pointer_record（泵指针记录表）
- pump_temp_record（泵温度记录表）
- pump_vibration_record（泵振动记录表）
- switch_position_record（手动开关位置记录表）

（每个表均有：id、mp_id（测点id）、status/数值、time（记录时间）、create_time、update_time，部分表有特定业务字段如pressure、temp、x_acc等，详见SQL文件）

---

## 3. 主要业务与管理系统说明

- 用户/权限：注册、登录、登出、角色、权限、用户管理
- 设备/测点：设备、测点、状态、健康、与车间关联
- 摄像头/模型：摄像头信息、模型上传/激活/同步、摄像头与模型绑定
- 检测/报警：图片/视频/流检测、报警生成与管理、报警统计
- 视频/数据集/训练：视频管理、数据集上传、模型训练、训练结果管理
- 车间/工厂：车间信息、设备分布、统计

---

## 4. Spring Boot 全部接口

### 1. 用户与账号相关
- **POST** `/account/login` 登录
- **POST** `/account/logout` 登出
- **POST** `/account/changePassword` 修改密码

### 2. 用户管理
- **POST** `/user/loadList` 用户列表
- **POST** `/user/createOrUpdate` 新增/修改用户

### 3. 设备管理
- **POST** `/device/countStatus` 设备状态统计
- **POST** `/device/countType` 设备类型统计

### 4. 测点管理
- **POST** `/mp/loadList` 测点分页列表
- **POST** `/mp/loadImage` 加载测点图片
- **POST** `/mp/getDetail` 获取测点详情

### 5. 报警管理
- **POST** `/alarm/loadList` 报警数据列表
- **POST** `/alarm/changeToProcessed` 改变报警状态
- **POST** `/alarm/countStatus` 报警状态统计
- **POST** `/alarm/countType` 报警类型统计
- **POST** `/alarm/countAlarmTimeByMonth` 月份报警统计
- **POST** `/alarm/countProcessedTimeByMonth` 月份已处理报警统计

### 6. 车间管理
- **POST** `/workshop/countDevice` 车间设备统计

### 7. 摄像头与模型绑定
- **GET** `/camera_model_bind/list` 绑定列表
- **POST** `/camera_model_bind/add` 新增绑定
- **PUT** `/camera_model_bind/update` 修改绑定
- **DELETE** `/camera_model_bind/delete/{id}` 删除绑定
- **GET** `/camera_model_bind/{id}` 绑定详情
- **POST** `/camera_model_bind/detect/{id}` 通过绑定检测

### 8. 模型管理
- **GET** `/model_pt/list` 模型列表
- **GET** `/model_pt/{fileName}` 模型详情
- **POST** `/model_pt/activate` 激活模型
- **POST** `/model_pt/sync` 同步模型

### 9. 视频与数据集管理
- **GET** `/video/raw/list` 原始视频列表
- **GET** `/video/detect/list` 检测后视频列表
- **GET** `/video/raw/{filename}` 下载原始视频
- **GET** `/video/detect/{filename}` 下载检测后视频

### 10. 训练与数据集上传
- **POST** `/upload_dataset` 上传数据集
- **POST** `/train_yolo` 训练YOLO

### 11. 检测相关接口
- **POST** `/detect/detect` 图片检测
- **/yolo/** 路径下所有YOLO检测、模型上传、视频检测等接口

### 12. 摄像头流与检测控制
- **/camera/** 路径下所有摄像头流、检测、状态、列表、RTSP探测等接口

（每个接口详细参数、返回、用途、示例见前文详细接口列表）

---

## 5. Flask app.py & camera_detect_api.py 全部接口

### app.py 主要接口
- **POST** `/api/load_model` 加载模型
- **POST** `/api/detect_base64` 检测图片（base64）
- **POST** `/api/detect_video_base64` 检测视频（base64）
- **GET** `/api/model_status` 模型状态
- **GET** `/api/list_models` 模型列表
- **GET** `/api/list_images` 获取测试图片列表
- **GET** `/api/list_datasets` 获取数据集列表
- **POST** `/api/upload_model` 上传模型
- **POST** `/api/upload_dataset` 上传数据集
- **POST** `/api/train_yolo` 训练YOLO
- **GET** `/api/download_model` 下载训练模型
- **GET** `/api/train_result_image` 下载训练结果图片

### camera_detect_api.py 主要接口
- **POST** `/api/camera/start` 启动摄像头检测
- **POST** `/api/camera/stop` 停止摄像头检测
- **GET** `/api/camera/stream` 摄像头实时流
- **POST** `/api/camera/stream/stop` 停止摄像头流
- **GET** `/api/camera/list` 摄像头列表
- **GET** `/api/camera/status` 检查检测状态
- **POST** `/api/camera/auto_detect_rtsp` 自动探测RTSP流
- **GET** `/api/videos/raw` `/api/videos/detect` 原始/检测后视频列表
- **GET** `/api/videos/raw/<filename>` `/api/videos/detect/<filename>` 下载视频

（每个接口详细参数、返回、用途、示例见前文详细接口列表）

---

## 6. 文件/目录说明

| 路径/文件                | 说明                         |
|--------------------------|------------------------------|
| back/src/                | Spring Boot Java源码          |
| back/model/              | 业务模型/实体                |
| back/uploads/            | 上传文件存储                 |
| back/pom.xml             | Maven依赖                    |
| yolov5-master/app.py     | Flask主入口                  |
| yolov5-master/camera_detect_api.py | 摄像头流/检测API      |
| yolov5-master/model/     | YOLOv5 .pt模型文件           |
| yolov5-master/requirements.txt | Python依赖              |
| yolov5-master/uploads/   | 上传/中转文件                |
| yolov5-master/results/   | 检测结果输出                 |

---

## 7. FAQ与维护建议

- **模型管理**：上传新.pt模型后，需同步数据库（Spring Boot端已自动同步）
- **接口变更**：如需新增/调整接口，建议先更新接口文档
- **日志排查**：Spring Boot日志在`back/logs/`，Flask日志可自定义
- **安全建议**：生产环境建议加鉴权、限流、日志脱敏等
- **依赖升级**：定期升级YOLOv5、Flask、Spring Boot等依赖

---

## 8. 典型业务流程举例

### 1. 模型上传与激活
1. 管理员通过Spring Boot接口上传.pt模型
2. Spring Boot自动同步数据库
3. 可通过接口激活/切换模型

### 2. 摄像头检测任务
1. 前端通过Spring Boot接口启动摄像头检测
2. Spring Boot转发请求到Flask
3. Flask处理检测，保存结果，Spring Boot可查询状态/结果

### 3. 报警处理
1. 检测到异常自动生成报警
2. 管理端可查询、处理、统计报警

---

## 9. 示例接口请求/响应

（见前文各接口详细说明，包含Spring Boot和Flask所有主要接口的请求/响应示例）

---

如需ER图、流程图、接口示例、字段详细说明等补充，请随时告知！ 